# Deploy API to Fly.io
#
# Triggers on:
# - Push to main (when API or lib changes)
# - Manual dispatch
#
# Required secrets:
# - FLY_API_TOKEN: Fly.io API token (get from `fly tokens create deploy`)

name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - "packages/api/**"
      - "packages/lib/**"
      - "data/seed/**"
      - ".github/workflows/deploy-api.yml"
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    environment: prod
    # Only run on main repo, not forks
    if: github.repository == 'spicygolf/spicy'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        # Note: This action tags major versions (v1) with latest semver, so v1 gets updates automatically.
        # Avoid pinning to specific versions like v1.5 - they use '1.5' not 'v1.5' for minor tags.
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy to Fly.io
        run: |
          flyctl deploy \
            --config packages/api/fly.toml \
            --dockerfile packages/api/Dockerfile \
            .
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
